generator client {
  provider = "prisma-client"
  output = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model AdminUser {
  id            Int           @id @default(autoincrement())
  username      String        @unique
  passwordHash  String
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Session {
  sid           String        @id @db.VarChar(255)
  sess          Json
  expire        DateTime      @db.Timestamp(6)

  @@map("session")
}

model Product {
  id            Int           @id @default(autoincrement())

  title         String
  subtitle      String?
  description   String

  price         Int                 // stored in cents
  discount      Int?                // stored in cents

  quantity      Int
  images        ProductImage[]

  orderItems    OrderItem[]

  isActive      Boolean       @default(true)

  createAt      DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model ProductImage {
  id            Int           @id @default(autoincrement())
  url           String
  publicId      String
  altText       String
  isPrimary     Boolean       @default(false)

  productId     Int
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Order {
  id            Int           @id @default(autoincrement())

  // Customer info
  email         String
  phone         String?
  fullName      String
  addressLine1  String
  addressLine2  String?
  city          String
  province      String
  postalCode    String
  country       String

  // Financials
  subtotal      Int
  shipping      Int
  total         Int

  status        OrderStatus   @default(PENDING)

  // Relationships
  items         OrderItem[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model OrderItem {
  id            Int           @id @default(autoincrement())

  order         Order         @relation(fields: [orderId], references: [id])
  orderId       Int

  product       Product       @relation(fields: [productId], references: [id])
  productId     Int

  // Snapshot of product info at purchase time
  title         String
  price         Int
  quantity      Int
  discount      Int?

  lineTotal     Int                 // (price - discount) * quantity
}

enum OrderStatus {
  PENDING       // waiting for Stripe webhook
  PAID          // payment confirmed
  PREPARING     // admin preparing order for shipping
  SHIPPED       // order shipped
  CANCELLED     // order cancelled (payment failed or manually cancelled) - pending refund
  REFUNDED      // order cancelled and refund has been issued
}